{% extends "base.html" %}

{% block title %}
    {% if displayRequested and requested_workout %}
        {{ user.workouts | selectattr('id', 'equalto', requested_workout | int) | first | attr('name') }} - Workout
    {% else %}
        Workout - Ares
    {% endif %}
{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/workout-modern.css') }}">
{% endblock %}

{% block active %}
<li class="nav-item" role="none">
    <a class="nav-link" href="/" role="menuitem">
        <i class="fa-solid fa-home nav-icon"></i>
        <span class="nav-text">Home</span>
    </a>
</li>
<li class="nav-item" role="none">
    <a class="nav-link active" href="/workout" role="menuitem">
        <i class="fa-solid fa-dumbbell nav-icon"></i>
        <span class="nav-text">Workout</span>
    </a>
</li>
<li class="nav-item" role="none">
    <a class="nav-link" href="/new-workout" role="menuitem">
        <i class="fa-solid fa-plus nav-icon"></i>
        <span class="nav-text">New Workout</span>
    </a>
</li>
{% endblock %}

{% block body %}

{% if not user.workouts %}
    <!-- Modern Empty State with Enhanced Hero Design -->
    <div class="workout-empty-state-modern">
        <div class="empty-state-background-effects">
            <div class="bg-gradient-orb orb-1"></div>
            <div class="bg-gradient-orb orb-2"></div>
            <div class="bg-gradient-orb orb-3"></div>
            <div class="bg-mesh-pattern"></div>
        </div>
        
        <div class="empty-state-container">
            <div class="empty-state-content-wrapper">
                <div class="empty-state-visual-section">
                    <div class="empty-state-icon-container">
                        <div class="icon-background-glow"></div>
                        <div class="empty-state-main-icon">
                            <i class="fa-solid fa-dumbbell"></i>
                        </div>
                        <div class="icon-pulse-ring"></div>
                    </div>
                </div>
                
                <div class="empty-state-text-section">
                    <h1 class="empty-state-title">
                        <span class="title-highlight">Start Your Fitness Journey</span>
                        <span class="title-subtitle">No workouts found</span>
                    </h1>
                    <p class="empty-state-description">
                        Create your first workout routine and take the first step towards achieving your fitness goals. 
                        Our intuitive tracker helps you monitor progress, stay motivated, and build lasting habits.
                    </p>
                    
                    <div class="empty-state-features">
                        <div class="feature-pill">
                            <i class="fa-solid fa-chart-line"></i>
                            <span>Track Progress</span>
                        </div>
                        <div class="feature-pill">
                            <i class="fa-solid fa-target"></i>
                            <span>Set Goals</span>
                        </div>
                        <div class="feature-pill">
                            <i class="fa-solid fa-bolt"></i>
                            <span>Stay Motivated</span>
                        </div>
                    </div>
                </div>
                
                <div class="empty-state-actions">
                    <a class="primary-cta-button" href="/new-workout" role="button">
                        <div class="button-content">
                            <div class="button-icon">
                                <i class="fa-solid fa-plus"></i>
                            </div>
                            <div class="button-text">
                                <span class="main-text">Create Your First Workout</span>
                                <span class="sub-text">Start building your routine</span>
                            </div>
                        </div>
                        <div class="button-shine"></div>
                    </a>
                </div>
            </div>
        </div>
    </div>

{% else %}

    <!-- Enhanced Modern Workout Dashboard -->
    <div class="modern-workout-dashboard">
        
        <!-- Dashboard Header with Animated Background -->
        <header class="workout-dashboard-header">
            <div class="header-background-effects">
                <div class="header-gradient-overlay"></div>
                <div class="header-pattern-overlay"></div>
                <div class="floating-particles">
                    <div class="particle particle-1"></div>
                    <div class="particle particle-2"></div>
                    <div class="particle particle-3"></div>
                    <div class="particle particle-4"></div>
                </div>
            </div>
            
            <div class="workout-header-content">
                <div class="header-main-section">
                    <div class="workout-branding">
                        <div class="workout-logo-section">
                            <div class="workout-icon-container">
                                <i class="fa-solid fa-dumbbell"></i>
                            </div>
                        </div>
                        <div class="header-text-content">
                            <h1 class="workout-page-title">
                                <span class="title-primary">Active Workout</span>
                                <span class="title-secondary">Ready to train?</span>
                            </h1>
                            <p class="workout-page-subtitle">Select a workout and start your training session</p>
                        </div>
                    </div>
                    
                    <div class="workout-selector-modern">
                        <div class="selector-wrapper">
                            <label for="select_workout" class="selector-label">
                                <i class="fa-solid fa-list"></i>
                                Choose your workout:
                            </label>
                            <div class="custom-select-container">
                                <select id="select_workout" class="workout-select-modern" aria-label="Select workout">
                                    {% for workout in user.workouts %}
                                        <option value="{{ workout.id }}" 
                                                data-category="{{ workout.category.name if workout.category else 'Uncategorized' }}" 
                                                data-exercises="{{ workout.exercises|length }}"
                                                data-description="{{ workout.description or '' }}">
                                            {{ workout.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <div class="select-dropdown-arrow">
                                    <i class="fa-solid fa-chevron-down"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="header-stats-section">
                    <div class="stats-grid">
                        <div class="stat-card total-workouts">
                            <div class="stat-icon">
                                <i class="fa-solid fa-dumbbell"></i>
                            </div>
                            <div class="stat-content">
                                <span class="stat-number">{{ user.workouts|length }}</span>
                                <span class="stat-label">Workout{{ 's' if user.workouts|length != 1 else '' }}</span>
                            </div>
                            <div class="stat-trend">
                                <i class="fa-solid fa-arrow-up"></i>
                            </div>
                        </div>
                        
                        <div class="stat-card total-exercises">
                            <div class="stat-icon">
                                <i class="fa-solid fa-list-check"></i>
                            </div>
                            <div class="stat-content">
                                <span class="stat-number">{{ (user.workouts | map(attribute='exercises') | map('length') | sum) if user.workouts else 0 }}</span>
                                <span class="stat-label">
                                    {% set total_exercises = (user.workouts | map(attribute='exercises') | map('length') | sum) if user.workouts else 0 %}
                                    Exercise{{ 's' if total_exercises != 1 else '' }}
                                </span>
                            </div>
                            <div class="stat-trend">
                                <i class="fa-solid fa-fire"></i>
                            </div>
                        </div>
                        
                        <div class="stat-card ready-status">
                            <div class="stat-icon">
                                <i class="fa-solid fa-circle-check"></i>
                            </div>
                            <div class="stat-content">
                                <span class="stat-number">100%</span>
                                <span class="stat-label">Ready</span>
                            </div>
                            <div class="stat-trend">
                                <i class="fa-solid fa-thumbs-up"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Workout Content Area -->
        <main class="workout-main-content">
            {% for workout in user.workouts %}
                <div class="workout-session-container workout-{{ workout.id }}" data-workout-id="{{ workout.id }}" hidden>
                    
                    <!-- Workout Overview Card -->
                    <section class="workout-overview-card">
                        <div class="overview-card-background">
                            <div class="card-gradient"></div>
                            <div class="card-pattern"></div>
                        </div>
                        
                        <div class="overview-card-content">
                            <div class="workout-info-section">
                                <div class="workout-title-area">
                                    <h2 class="current-workout-title">{{ workout.name }}</h2>
                                    {% if workout.description %}
                                        <p class="current-workout-description">{{ workout.description }}</p>
                                    {% endif %}
                                </div>
                                
                                <div class="workout-metadata-badges">
                                    {% if workout.category %}
                                        <span class="metadata-badge category-badge">
                                            <i class="fa-solid fa-tag"></i>
                                            {{ workout.category.name }}
                                        </span>
                                    {% endif %}
                                    <span class="metadata-badge exercise-count-badge">
                                        <i class="fa-solid fa-list"></i>
                                        {{ workout.exercises|length }} exercise{{ 's' if workout.exercises|length != 1 else '' }}
                                    </span>
                                    <span class="metadata-badge duration-badge">
                                        <i class="fa-solid fa-clock"></i>
                                        ~{{ (workout.exercises|length * 15) }} min
                                    </span>
                                </div>
                            </div>
                            
                            <div class="workout-actions-quick">
                                <button type="button" class="quick-action-btn edit-btn edit-{{ workout.id }}" data-workout-id="{{ workout.id }}">
                                    <i class="fa-solid fa-edit"></i>
                                    <span>Edit</span>
                                </button>
                                <button type="button" class="quick-action-btn timer-btn" data-workout-id="{{ workout.id }}">
                                    <i class="fa-solid fa-stopwatch"></i>
                                    <span>Timer</span>
                                </button>
                            </div>
                        </div>
                    </section>

                    <!-- Enhanced Exercises Grid -->
                    <section class="exercises-training-section">
                        <div class="section-header">
                            <h3 class="section-title">
                                <i class="fa-solid fa-fire"></i>
                                Training Exercises
                            </h3>
                            <div class="progress-overview">
                                <span class="progress-text">Progress:</span>
                                <div class="mini-progress-bar">
                                    {% set completed_exercises = [] %}
                                    {% for exercise in workout.exercises %}
                                        {% set exercise_completed = false %}
                                        {% for session in user.workout_sessions %}
                                            {% if session.workout_id == workout.id %}
                                                {% for log in session.exercise_logs %}
                                                    {% if log.exercise_name == exercise.name and log.weight is defined and log.weight > 0 %}
                                                        {% set exercise_completed = true %}
                                                        {% break %}
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                            {% if exercise_completed %}{% break %}{% endif %}
                                        {% endfor %}
                                        {% if exercise_completed %}
                                            {% set _ = completed_exercises.append(exercise.name) %}
                                        {% endif %}
                                    {% endfor %}
                                    {% set completed_count = completed_exercises | length %}
                                    {% set total = workout.exercises|length %}
                                    <div class="progress-fill" id="mini-progress-{{ workout.id }}" 
                                         style="width: {{ ((completed_count / total * 100) | round(0) | int) if total > 0 else 0 }}%">
                                    </div>
                                </div>
                                <span class="progress-percentage" id="mini-progress-text-{{ workout.id }}">
                                    {{ ((completed_count / total * 100) | round(0) | int) if total > 0 else 0 }}%
                                </span>
                            </div>
                        </div>
                        
                        <div class="exercises-grid-modern">
                            {% for exercise in workout.exercises %}
                                <article class="exercise-card-modern" data-exercise-index="{{ loop.index0 }}" data-exercise-id="{{ exercise.id }}">
                                    <!-- Exercise Card Header -->
                                    <header class="exercise-card-header">
                                        <div class="exercise-number-badge">
                                            <span class="exercise-position">{{ loop.index }}</span>
                                        </div>
                                        <div class="exercise-info">
                                            <h4 class="exercise-name">{{ exercise.name }}</h4>
                                            <div class="exercise-status-indicator">
                                                {% set has_logged_top_set = false %}
                                                {% for session in user.workout_sessions %}
                                                    {% if session.workout_id == workout.id %}
                                                        {% for log in session.exercise_logs %}
                                                            {% if log.exercise_name == exercise.name and log.weight is defined and log.weight > 0 %}
                                                                {% set has_logged_top_set = true %}
                                                                {% break %}
                                                            {% endif %}
                                                        {% endfor %}
                                                    {% endif %}
                                                    {% if has_logged_top_set %}{% break %}{% endif %}
                                                {% endfor %}
                                                {% if has_logged_top_set %}
                                                    <span class="status-badge completed">
                                                        <i class="fa-solid fa-check-circle"></i>
                                                        Completed
                                                    </span>
                                                {% else %}
                                                    <span class="status-badge pending">
                                                        <i class="fa-regular fa-circle"></i>
                                                        Pending
                                                    </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </header>
                                    
                                    <!-- Exercise Card Body -->
                                    <div class="exercise-card-body">
                                        <div class="exercise-metrics-container">
                                            
                                            <!-- Interactive Weight Input -->
                                            <div class="metric-group weight-metric">
                                                <label class="metric-label">
                                                    <i class="fa-solid fa-weight-hanging"></i>
                                                    Weight
                                                </label>
                                                
                                                <div class="metric-input weight-input-interactive">
                                                    <div class="input-group-modern">
                                                        <input 
                                                            id="weight-{{ workout.id }}-{{ loop.index0 }}" 
                                                            class="metric-input-field weight-field interactive-input" 
                                                            type="number" 
                                                            step="0.01" 
                                                            placeholder="Enter weight" 
                                                            name="weight" 
                                                            value="{% if exercise.weight is not none %}{{ (exercise.weight | int) if (exercise.weight | float | is_integer) else exercise.weight }}{% endif %}"
                                                            min="0"
                                                            max="999.99"
                                                            aria-label="Weight for {{ exercise.name }}"
                                                            data-exercise-id="{{ exercise.id }}"
                                                            data-workout-id="{{ workout.id }}"
                                                            data-field-type="weight"
                                                        >
                                                        <span class="input-unit">kg</span>
                                                        <div class="input-focus-line"></div>
                                                    </div>
                                                    <div class="save-indicator" style="display: none;">
                                                        <i class="fa-solid fa-check"></i>
                                                        <span>Saved</span>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Interactive Reps Input -->
                                            <div class="metric-group reps-metric">
                                                <label class="metric-label">
                                                    <i class="fa-solid fa-repeat"></i>
                                                    Reps
                                                </label>
                                                
                                                <div class="metric-input reps-input-interactive">
                                                    <div class="input-group-modern">
                                                        <input 
                                                            id="reps-{{ workout.id }}-{{ loop.index0 }}" 
                                                            class="metric-input-field reps-field interactive-input" 
                                                            type="text" 
                                                            placeholder="e.g., 8-12 or 10" 
                                                            name="reps" 
                                                            value="{{ exercise.reps or '' }}" 
                                                            maxlength="20"
                                                            aria-label="Reps for {{ exercise.name }}"
                                                            data-exercise-id="{{ exercise.id }}"
                                                            data-workout-id="{{ workout.id }}"
                                                            data-field-type="reps"
                                                        >
                                                        <div class="input-focus-line"></div>
                                                    </div>
                                                    <div class="save-indicator" style="display: none;">
                                                        <i class="fa-solid fa-check"></i>
                                                        <span>Saved</span>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Interactive Details Section (if applicable) -->
                                            {% if exercise.include_details %}
                                                <div class="metric-group details-metric">
                                                    <label class="metric-label">
                                                        <i class="fa-solid fa-clipboard-list"></i>
                                                        Details
                                                    </label>
                                                    
                                                    <div class="metric-input details-input-interactive">
                                                        <div class="input-group-modern">
                                                            <input 
                                                                id="details-{{ workout.id }}-{{ loop.index0 }}" 
                                                                class="metric-input-field details-field interactive-input" 
                                                                type="text" 
                                                                placeholder="e.g., 3x8, seat 5" 
                                                                name="details" 
                                                                value="{{ exercise.details or '' }}" 
                                                                maxlength="50"
                                                                aria-label="Details for {{ exercise.name }}"
                                                                data-exercise-id="{{ exercise.id }}"
                                                                data-workout-id="{{ workout.id }}"
                                                                data-field-type="details"
                                                            >
                                                            <div class="input-focus-line"></div>
                                                        </div>
                                                        <div class="save-indicator" style="display: none;">
                                                            <i class="fa-solid fa-check"></i>
                                                            <span>Saved</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endif %}

                                        </div>
                                    </div>
                                    
                                    <!-- Exercise Card Footer -->
                                    <footer class="exercise-card-footer">
                                        <div class="exercise-actions">
                                            <button type="button" class="exercise-action-btn quick-log-btn" data-exercise-index="{{ loop.index0 }}">
                                                <i class="fa-solid fa-plus-circle"></i>
                                                Quick Log
                                            </button>
                                            <button type="button" class="exercise-action-btn notes-btn" data-exercise-index="{{ loop.index0 }}">
                                                <i class="fa-solid fa-sticky-note"></i>
                                                Notes
                                            </button>
                                        </div>
                                    </footer>
                                </article>
                            {% endfor %}
                        </div>
                    </section>

                    <!-- Enhanced Progress Summary -->
                    <section class="workout-progress-summary">
                        <div class="progress-card">
                            <div class="progress-card-header">
                                <div class="progress-icon">
                                    <i class="fa-solid fa-chart-line"></i>
                                </div>
                                <div class="progress-title-section">
                                    <h3 class="progress-title">Workout Progress</h3>
                                    <p class="progress-subtitle">Track your completion status</p>
                                </div>
                            </div>
                            
                            <div class="progress-metrics">
                                <div class="progress-stats-grid">
                                    <div class="progress-stat completed-stat">
                                        <div class="stat-icon">
                                            <i class="fa-solid fa-check-circle"></i>
                                        </div>
                                        <div class="stat-info">
                                            <span class="stat-value" id="completed-exercises-{{ workout.id }}">
                                                {% set completed_exercise_names = [] %}
                                                {% for exercise in workout.exercises %}
                                                    {% set exercise_completed = false %}
                                                    {% for session in user.workout_sessions %}
                                                        {% if session.workout_id == workout.id %}
                                                            {% for log in session.exercise_logs %}
                                                                {% if log.exercise_name == exercise.name and log.weight is defined and log.weight > 0 %}
                                                                    {% set exercise_completed = true %}
                                                                    {% break %}
                                                                {% endif %}
                                                            {% endfor %}
                                                        {% endif %}
                                                        {% if exercise_completed %}{% break %}{% endif %}
                                                    {% endfor %}
                                                    {% if exercise_completed %}
                                                        {% set _ = completed_exercise_names.append(exercise.name) %}
                                                    {% endif %}
                                                {% endfor %}
                                                {% set completed_exercises = completed_exercise_names | length %}
                                                {{ completed_exercises }}
                                            </span>
                                            <span class="stat-label">Completed</span>
                                        </div>
                                    </div>
                                    
                                    <div class="progress-stat total-stat">
                                        <div class="stat-icon">
                                            <i class="fa-solid fa-list"></i>
                                        </div>
                                        <div class="stat-info">
                                            <span class="stat-value">{{ workout.exercises|length }}</span>
                                            <span class="stat-label">Total</span>
                                        </div>
                                    </div>
                                    
                                    <div class="progress-stat percentage-stat">
                                        <div class="stat-icon">
                                            <i class="fa-solid fa-percentage"></i>
                                        </div>
                                        <div class="stat-info">
                                            <span class="stat-value" id="completion-percentage-{{ workout.id }}">
                                                {% set completed_exercise_list = [] %}
                                                {% for exercise in workout.exercises %}
                                                    {% set exercise_completed = false %}
                                                    {% for session in user.workout_sessions %}
                                                        {% if session.workout_id == workout.id %}
                                                            {% for log in session.exercise_logs %}
                                                                {% if log.exercise_name == exercise.name and log.weight is defined and log.weight > 0 %}
                                                                    {% set exercise_completed = true %}
                                                                    {% break %}
                                                                {% endif %}
                                                            {% endfor %}
                                                        {% endif %}
                                                        {% if exercise_completed %}{% break %}{% endif %}
                                                    {% endfor %}
                                                    {% if exercise_completed %}
                                                        {% set _ = completed_exercise_list.append(exercise.name) %}
                                                    {% endif %}
                                                {% endfor %}
                                                {% set completed_count = completed_exercise_list | length %}
                                                {% set total_count = workout.exercises|length %}
                                                {{ ((completed_count / total_count * 100) | round(0) | int) if total_count > 0 else 0 }}%
                                            </span>
                                            <span class="stat-label">Complete</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="progress-bar-container">
                                    <div class="progress-bar-track">
                                        {% set completed_exercise_progress = [] %}
                                        {% for exercise in workout.exercises %}
                                            {% set exercise_completed = false %}
                                            {% for session in user.workout_sessions %}
                                                {% if session.workout_id == workout.id %}
                                                    {% for log in session.exercise_logs %}
                                                        {% if log.exercise_name == exercise.name and log.weight is defined and log.weight > 0 %}
                                                            {% set exercise_completed = true %}
                                                            {% break %}
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endif %}
                                                {% if exercise_completed %}{% break %}{% endif %}
                                            {% endfor %}
                                            {% if exercise_completed %}
                                                {% set _ = completed_exercise_progress.append(exercise.name) %}
                                            {% endif %}
                                        {% endfor %}
                                        {% set completed_count = completed_exercise_progress | length %}
                                        {% set total_count = workout.exercises|length %}
                                        <div class="progress-bar-fill" id="progress-fill-{{ workout.id }}" 
                                             style="width: {{ ((completed_count / total_count * 100) | round(0) | int) if total_count > 0 else 0 }}%">
                                            <div class="progress-bar-glow"></div>
                                        </div>
                                    </div>
                                    <div class="progress-markers">
                                        {% for i in range(workout.exercises|length) %}
                                            <div class="progress-marker" data-exercise="{{ i }}"></div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                </div>
            {% endfor %}
        </main>
    </div>

{% endif %}

<!-- Enhanced Workout Timer Modal -->
<div class="workout-timer-modal" id="workout-timer-modal">
    <div class="timer-modal-overlay"></div>
    <div class="timer-modal-content">
        <header class="timer-modal-header">
            <h3 class="timer-title">
                <i class="fa-solid fa-stopwatch"></i>
                Workout Timer
            </h3>
            <button class="timer-close-btn" id="close-timer-modal">
                <i class="fa-solid fa-times"></i>
            </button>
        </header>
        
        <div class="timer-display">
            <div class="timer-circle">
                <div class="timer-time" id="timer-display">00:00</div>
                <div class="timer-label">Elapsed Time</div>
            </div>
        </div>
        
        <div class="timer-controls">
            <button class="timer-btn start-btn" id="timer-start">
                <i class="fa-solid fa-play"></i>
                Start
            </button>
            <button class="timer-btn pause-btn" id="timer-pause" hidden>
                <i class="fa-solid fa-pause"></i>
                Pause
            </button>
            <button class="timer-btn reset-btn" id="timer-reset">
                <i class="fa-solid fa-refresh"></i>
                Reset
            </button>
        </div>
    </div>
</div>

<!-- Enhanced JavaScript -->
<script>
    // Enhanced workout selection and management
    document.addEventListener('DOMContentLoaded', function() {
        const selectWorkout = document.getElementById('select_workout');
        
        // Initialize workout display
        {% if displayRequested and requested_workout %}
            if (selectWorkout) {
                selectWorkout.value = "{{ requested_workout }}";
                showSelectedWorkout("{{ requested_workout }}");
            }
        {% else %}
            if (selectWorkout && selectWorkout.options.length > 0) {
                const firstWorkoutId = selectWorkout.options[0].value;
                showSelectedWorkout(firstWorkoutId);
            }
        {% endif %}

        // Handle workout selection change with animation
        if (selectWorkout) {
            selectWorkout.addEventListener('change', function() {
                const selectedWorkoutId = this.value;
                animateWorkoutTransition(selectedWorkoutId);
            });
        }

        // Initialize timer functionality
        initializeWorkoutTimer();
        
        // Initialize progress animations
        animateProgressBars();
        
        // Initialize quick action buttons
        initializeQuickActions();
        
        // Initialize interactive input fields
        initializeInteractiveInputs();
    });

    function showSelectedWorkout(workoutId) {
        // Hide all workouts
        const allWorkouts = document.querySelectorAll('.workout-session-container');
        allWorkouts.forEach(workout => {
            workout.hidden = true;
            workout.classList.remove('active');
        });

        // Show selected workout with animation
        const selectedWorkout = document.querySelector(`.workout-${workoutId}`);
        if (selectedWorkout) {
            selectedWorkout.hidden = false;
            setTimeout(() => {
                selectedWorkout.classList.add('active');
            }, 50);
        }
    }

    function animateWorkoutTransition(workoutId) {
        const currentWorkout = document.querySelector('.workout-session-container:not([hidden])');
        const newWorkout = document.querySelector(`.workout-${workoutId}`);
        
        if (currentWorkout) {
            currentWorkout.style.opacity = '0';
            currentWorkout.style.transform = 'translateY(-20px)';
            
            setTimeout(() => {
                currentWorkout.hidden = true;
                currentWorkout.style.opacity = '';
                currentWorkout.style.transform = '';
                
                if (newWorkout) {
                    newWorkout.hidden = false;
                    newWorkout.style.opacity = '0';
                    newWorkout.style.transform = 'translateY(20px)';
                    
                    setTimeout(() => {
                        newWorkout.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                        newWorkout.style.opacity = '1';
                        newWorkout.style.transform = 'translateY(0)';
                        
                        setTimeout(() => {
                            newWorkout.style.transition = '';
                        }, 400);
                    }, 50);
                }
            }, 200);
        } else {
            showSelectedWorkout(workoutId);
        }
    }

    function updateProgressDisplay(workoutId) {
        // Progress display is now handled server-side based on logged sessions
        // This function can be used for real-time updates after successful saves
        // For now, we'll keep the existing UI state until page refresh
        console.log(`Progress updated for workout ${workoutId} - refresh page to see completion status`);
    }

    function animateProgressBars() {
        const progressBars = document.querySelectorAll('.progress-bar-fill');
        progressBars.forEach(bar => {
            const width = bar.style.width;
            bar.style.width = '0%';
            setTimeout(() => {
                bar.style.transition = 'width 1s ease-out';
                bar.style.width = width;
            }, 500);
        });
    }

    function initializeWorkoutTimer() {
        const timerModal = document.getElementById('workout-timer-modal');
        const closeBtn = document.getElementById('close-timer-modal');
        const startBtn = document.getElementById('timer-start');
        const pauseBtn = document.getElementById('timer-pause');
        const resetBtn = document.getElementById('timer-reset');
        const timerDisplay = document.getElementById('timer-display');
        
        let startTime = null;
        let pausedTime = 0;
        let isRunning = false;
        let timerInterval = null;

        // Open timer modal
        document.querySelectorAll('.timer-btn, .timer-control').forEach(btn => {
            btn.addEventListener('click', function() {
                timerModal.classList.add('active');
                document.body.style.overflow = 'hidden';
            });
        });

        // Close timer modal
        closeBtn.addEventListener('click', function() {
            timerModal.classList.remove('active');
            document.body.style.overflow = '';
        });

        // Timer controls
        startBtn.addEventListener('click', function() {
            if (!isRunning) {
                startTime = Date.now() - pausedTime;
                isRunning = true;
                startBtn.hidden = true;
                pauseBtn.hidden = false;
                
                timerInterval = setInterval(updateTimer, 1000);
            }
        });

        pauseBtn.addEventListener('click', function() {
            if (isRunning) {
                isRunning = false;
                pausedTime = Date.now() - startTime;
                startBtn.hidden = false;
                pauseBtn.hidden = true;
                clearInterval(timerInterval);
            }
        });

        resetBtn.addEventListener('click', function() {
            isRunning = false;
            pausedTime = 0;
            startTime = null;
            startBtn.hidden = false;
            pauseBtn.hidden = true;
            clearInterval(timerInterval);
            timerDisplay.textContent = '00:00';
        });

        function updateTimer() {
            if (!isRunning) return;
            
            const elapsed = Date.now() - startTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            
            timerDisplay.textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
    }

    function initializeQuickActions() {
        // Quick log buttons
        document.querySelectorAll('.quick-log-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const exerciseIndex = this.dataset.exerciseIndex;
                const exerciseCard = this.closest('.exercise-card-modern');
                const weightInput = exerciseCard.querySelector('.weight-field');
                
                if (weightInput) {
                    // Simple quick log - could be enhanced with preset weights
                    const lastWeight = localStorage.getItem(`lastWeight_${exerciseIndex}`) || '20';
                    weightInput.value = lastWeight;
                    weightInput.focus();
                    
                    // Trigger save after setting value
                    weightInput.dispatchEvent(new Event('input'));
                    
                    // Save for next time
                    weightInput.addEventListener('blur', function() {
                        if (this.value) {
                            localStorage.setItem(`lastWeight_${exerciseIndex}`, this.value);
                        }
                    });
                }
            });
        });

        // Notes buttons (placeholder for future enhancement)
        document.querySelectorAll('.notes-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Could open a notes modal or expand details section
                console.log('Notes feature - coming soon!');
            });
        });
    }

    // PUBLIC_INTERFACE
    /**
     * Initialize real-time interactive input fields for exercise data.
     * Provides immediate feedback and AJAX saving for smooth user experience.
     */
    function initializeInteractiveInputs() {
        
        const debounceTimers = new Map();
        const DEBOUNCE_DELAY = 800; // ms to wait before saving
        
        // Add event listeners to all interactive input fields
        document.querySelectorAll('.interactive-input').forEach(input => {
            const exerciseId = input.dataset.exerciseId;
            const workoutId = input.dataset.workoutId;
            const fieldType = input.dataset.fieldType;
            
            // Handle input changes with debouncing
            input.addEventListener('input', function() {
                // Clear existing timer for this input
                const timerId = `${exerciseId}-${fieldType}`;
                if (debounceTimers.has(timerId)) {
                    clearTimeout(debounceTimers.get(timerId));
                }
                
                // Show typing indicator
                showSaveIndicator(this, 'typing');
                
                // Set new timer
                const timer = setTimeout(() => {
                    saveExerciseField(exerciseId, workoutId, fieldType, this.value, this);
                    debounceTimers.delete(timerId);
                }, DEBOUNCE_DELAY);
                
                debounceTimers.set(timerId, timer);
            });
            
            // Handle enter key for immediate save
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    
                    // Clear debounce timer and save immediately
                    const timerId = `${exerciseId}-${fieldType}`;
                    if (debounceTimers.has(timerId)) {
                        clearTimeout(debounceTimers.get(timerId));
                        debounceTimers.delete(timerId);
                    }
                    
                    saveExerciseField(exerciseId, workoutId, fieldType, this.value, this);
                    this.blur(); // Remove focus after save
                }
            });
            
            // Handle blur event for final save
            input.addEventListener('blur', function() {
                const timerId = `${exerciseId}-${fieldType}`;
                if (debounceTimers.has(timerId)) {
                    clearTimeout(debounceTimers.get(timerId));
                    debounceTimers.delete(timerId);
                    saveExerciseField(exerciseId, workoutId, fieldType, this.value, this);
                }
            });
        });
    }
    
    // PUBLIC_INTERFACE
    /**
     * Save individual exercise field via AJAX.
     * Provides immediate visual feedback and error handling.
     */
    function saveExerciseField(exerciseId, workoutId, fieldType, value, inputElement) {
        
        showSaveIndicator(inputElement, 'saving');
        
        // Use existing workout endpoint with enhanced functionality
        fetch('/workout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                workout_id: workoutId,
                exercise_id: exerciseId,
                field_type: fieldType,
                value: value,
                action: 'update_single_field'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSaveIndicator(inputElement, 'success');
                
                // Update progress indicators
                updateProgressDisplay(workoutId);
                
                // Update exercise status badge
                updateExerciseStatus(inputElement);
                
                // If a top set was logged, show special notification
                if (data.top_set_logged) {
                    showTopSetNotification(inputElement);
                }
                
            } else {
                showSaveIndicator(inputElement, 'error');
                console.error('Save failed:', data.errors || data.error);
                
                // Show user-friendly error
                if (data.errors && data.errors.length > 0) {
                    showTemporaryError(inputElement, data.errors[0]);
                } else if (data.error) {
                    showTemporaryError(inputElement, data.error);
                }
            }
        })
        .catch(error => {
            console.error('Network error:', error);
            showSaveIndicator(inputElement, 'error');
            showTemporaryError(inputElement, 'Network error - please try again');
        });
    }
    
    // PUBLIC_INTERFACE
    /**
     * Show visual feedback for save operations.
     */
    function showSaveIndicator(inputElement, status) {
        
        const container = inputElement.closest('.metric-input');
        if (!container) return;
        
        const indicator = container.querySelector('.save-indicator');
        if (!indicator) return;
        
        // Reset classes
        indicator.className = 'save-indicator';
        
        switch (status) {
            case 'typing':
                indicator.innerHTML = '<i class="fa-solid fa-pencil"></i><span>Typing...</span>';
                indicator.classList.add('typing');
                indicator.style.display = 'flex';
                break;
                
            case 'saving':
                indicator.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i><span>Saving...</span>';
                indicator.classList.add('saving');
                indicator.style.display = 'flex';
                break;
                
            case 'success':
                indicator.innerHTML = '<i class="fa-solid fa-check"></i><span>Saved</span>';
                indicator.classList.add('success');
                indicator.style.display = 'flex';
                
                // Hide after delay
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 2000);
                break;
                
            case 'error':
                indicator.innerHTML = '<i class="fa-solid fa-exclamation-triangle"></i><span>Error</span>';
                indicator.classList.add('error');
                indicator.style.display = 'flex';
                
                // Hide after delay
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 3000);
                break;
        }
    }
    
    // PUBLIC_INTERFACE
    /**
     * Update exercise completion status badge based on input values.
     */
    function updateExerciseStatus(inputElement) {
        
        const exerciseCard = inputElement.closest('.exercise-card-modern');
        if (!exerciseCard) return;
        
        const statusBadge = exerciseCard.querySelector('.status-badge');
        
        if (!statusBadge) return;
        
        // Don't update status badge immediately - completion status is determined 
        // by logged workout sessions, not just input values
        // The user needs to complete and log their workout session to mark exercises as completed
        // Status will be updated on page refresh after successful session logging
        console.log('Exercise data updated - complete workout session to mark as completed');
    }
    
    // PUBLIC_INTERFACE
    /**
     * Show temporary error message near input field.
     */
    function showTemporaryError(inputElement, message) {
        
        const container = inputElement.closest('.metric-group');
        if (!container) return;
        
        // Remove existing error messages
        const existingError = container.querySelector('.temp-error-message');
        if (existingError) {
            existingError.remove();
        }
        
        // Create error element
        const errorDiv = document.createElement('div');
        errorDiv.className = 'temp-error-message';
        errorDiv.innerHTML = `<i class="fa-solid fa-exclamation-triangle"></i> ${message}`;
        errorDiv.style.cssText = `
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: var(--error-bg);
            color: var(--text-on-primary);
            border-radius: var(--radius-md);
            font-size: var(--fs-sm);
            margin-top: var(--space-2);
            animation: slideInUp 0.3s ease-out;
        `;
        
        container.appendChild(errorDiv);
        
        // Remove after delay
        setTimeout(() => {
            errorDiv.style.opacity = '0';
            errorDiv.style.transform = 'translateY(-10px)';
            setTimeout(() => errorDiv.remove(), 300);
        }, 4000);
    }

    // PUBLIC_INTERFACE
    /**
     * Show special notification when a top set is logged.
     */
    function showTopSetNotification(inputElement) {
        const exerciseCard = inputElement.closest('.exercise-card-modern');
        if (!exerciseCard) return;
        
        // Create notification element
        const notification = document.createElement('div');
        notification.className = 'top-set-notification';
        notification.innerHTML = `
            <i class="fa-solid fa-trophy"></i>
            <span>Top Set Logged!</span>
        `;
        notification.style.cssText = `
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            position: absolute;
            top: -40px;
            right: 10px;
            z-index: 1000;
            animation: slideInDown 0.3s ease-out;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        `;
        
        exerciseCard.style.position = 'relative';
        exerciseCard.appendChild(notification);
        
        // Remove after delay
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateY(-10px)';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    // Intersection Observer for animations
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver(function(entries) {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('animate-in');
            }
        });
    }, observerOptions);

    // Observe exercise cards for stagger animation
    document.querySelectorAll('.exercise-card-modern').forEach(card => {
        observer.observe(card);
    });
</script>

<script type="text/javascript" src="/static/js/workout.js"></script>

{% endblock %}
