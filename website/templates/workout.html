{% extends "base.html" %}

{% block title %}
    {% if displayRequested and requested_workout %}
        {{ user.workouts | selectattr('id', 'equalto', requested_workout | int) | first | attr('name') }} - Workout
    {% else %}
        Workout - Ares
    {% endif %}
{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/workout-modern.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/previous-session-hints.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/workout-input-improvements.css') }}">
{% endblock %}

{% block active %}
<li class="nav-item" role="none">
    <a class="nav-link" href="/" role="menuitem">
        <i class="fa-solid fa-home nav-icon"></i>
        <span class="nav-text">Home</span>
    </a>
</li>
<li class="nav-item" role="none">
    <a class="nav-link active" href="/workout" role="menuitem">
        <i class="fa-solid fa-dumbbell nav-icon"></i>
        <span class="nav-text">Workout</span>
    </a>
</li>
<li class="nav-item" role="none">
    <a class="nav-link" href="/new-workout" role="menuitem">
        <i class="fa-solid fa-plus nav-icon"></i>
        <span class="nav-text">New Workout</span>
    </a>
</li>
{% endblock %}

{% block body %}

{% if not user.workouts %}
    <!-- Modern Empty State with Enhanced Hero Design -->
    <div class="workout-empty-state-modern">
        <div class="empty-state-background-effects">
            <div class="bg-gradient-orb orb-1"></div>
            <div class="bg-gradient-orb orb-2"></div>
            <div class="bg-gradient-orb orb-3"></div>
            <div class="bg-mesh-pattern"></div>
        </div>
        
        <div class="empty-state-container">
            <div class="empty-state-content-wrapper">
                <div class="empty-state-visual-section">
                    <div class="empty-state-icon-container">
                        <div class="icon-background-glow"></div>
                        <div class="empty-state-main-icon">
                            <i class="fa-solid fa-dumbbell"></i>
                        </div>
                        <div class="icon-pulse-ring"></div>
                    </div>
                </div>
                
                <div class="empty-state-text-section">
                    <h1 class="empty-state-title">
                        <span class="title-highlight">Start Your Fitness Journey</span>
                        <span class="title-subtitle">No workouts found</span>
                    </h1>
                    <p class="empty-state-description">
                        Create your first workout routine and take the first step towards achieving your fitness goals. 
                        Our intuitive tracker helps you monitor progress, stay motivated, and build lasting habits.
                    </p>
                    
                    <div class="empty-state-features">
                        <div class="feature-pill">
                            <i class="fa-solid fa-chart-line"></i>
                            <span>Track Progress</span>
                        </div>
                        <div class="feature-pill">
                            <i class="fa-solid fa-target"></i>
                            <span>Set Goals</span>
                        </div>
                        <div class="feature-pill">
                            <i class="fa-solid fa-bolt"></i>
                            <span>Stay Motivated</span>
                        </div>
                    </div>
                </div>
                
                <div class="empty-state-actions">
                    <a class="primary-cta-button" href="/new-workout" role="button">
                        <div class="button-content">
                            <div class="button-icon">
                                <i class="fa-solid fa-plus"></i>
                            </div>
                            <div class="button-text">
                                <span class="main-text">Create Your First Workout</span>
                                <span class="sub-text">Start building your routine</span>
                            </div>
                        </div>
                        <div class="button-shine"></div>
                    </a>
                </div>
            </div>
        </div>
    </div>

{% else %}

    <!-- Enhanced Modern Workout Dashboard -->
    <div class="modern-workout-dashboard">
        
        <!-- Dashboard Header with Animated Background -->
        <header class="workout-dashboard-header">
            <div class="header-background-effects">
                <div class="header-gradient-overlay"></div>
                <div class="header-pattern-overlay"></div>
                <div class="floating-particles">
                    <div class="particle particle-1"></div>
                    <div class="particle particle-2"></div>
                    <div class="particle particle-3"></div>
                    <div class="particle particle-4"></div>
                </div>
            </div>
            
            <div class="workout-header-content">
                <div class="header-main-section">
                    <div class="workout-branding">
                        <div class="workout-logo-section">
                            <div class="workout-icon-container">
                                <i class="fa-solid fa-dumbbell"></i>
                            </div>
                        </div>
                        <div class="header-text-content">
                            <h1 class="workout-page-title">
                                <span class="title-primary">Active Workout</span>
                                <span class="title-secondary">Ready to train?</span>
                            </h1>
                            <p class="workout-page-subtitle">Select a workout and start your training session</p>
                        </div>
                    </div>
                    
                    <div class="workout-selector-modern">
                        <div class="selector-wrapper">
                            <label for="select_workout" class="selector-label">
                                <i class="fa-solid fa-list"></i>
                                Choose your workout:
                            </label>
                            <div class="custom-select-container">
                                <select id="select_workout" class="workout-select-modern" aria-label="Select workout">
                                    {% for workout in user.workouts %}
                                        <option value="{{ workout.id }}" 
                                                data-category="{{ workout.category.name if workout.category else 'Uncategorized' }}" 
                                                data-exercises="{{ workout.exercises|length }}"
                                                data-description="{{ workout.description or '' }}">
                                            {{ workout.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <div class="select-dropdown-arrow">
                                    <i class="fa-solid fa-chevron-down"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="header-stats-section">
                    <div class="stats-grid">
                        <div class="stat-card total-workouts">
                            <div class="stat-icon">
                                <i class="fa-solid fa-dumbbell"></i>
                            </div>
                            <div class="stat-content">
                                <span class="stat-number">{{ user.workouts|length }}</span>
                                <span class="stat-label">Workout{{ 's' if user.workouts|length != 1 else '' }}</span>
                            </div>
                            <div class="stat-trend">
                                <i class="fa-solid fa-arrow-up"></i>
                            </div>
                        </div>
                        
                        <div class="stat-card total-exercises">
                            <div class="stat-icon">
                                <i class="fa-solid fa-list-check"></i>
                            </div>
                            <div class="stat-content">
                                <span class="stat-number">{{ (user.workouts | map(attribute='exercises') | map('length') | sum) if user.workouts else 0 }}</span>
                                <span class="stat-label">
                                    {% set total_exercises = (user.workouts | map(attribute='exercises') | map('length') | sum) if user.workouts else 0 %}
                                    Exercise{{ 's' if total_exercises != 1 else '' }}
                                </span>
                            </div>
                            <div class="stat-trend">
                                <i class="fa-solid fa-fire"></i>
                            </div>
                        </div>
                        
                        <div class="stat-card ready-status">
                            <div class="stat-icon">
                                <i class="fa-solid fa-circle-check"></i>
                            </div>
                            <div class="stat-content">
                                <span class="stat-number">100%</span>
                                <span class="stat-label">Ready</span>
                            </div>
                            <div class="stat-trend">
                                <i class="fa-solid fa-thumbs-up"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Workout Content Area -->
        <main class="workout-main-content">
            {% for workout in user.workouts %}
                <div class="workout-session-container workout-{{ workout.id }}" data-workout-id="{{ workout.id }}" hidden>
                    
                    <!-- Workout Overview Card -->
                    <section class="workout-overview-card">
                        <div class="overview-card-background">
                            <div class="card-gradient"></div>
                            <div class="card-pattern"></div>
                        </div>
                        
                        <div class="overview-card-content">
                            <div class="workout-info-section">
                                <div class="workout-title-area">
                                    <h2 class="current-workout-title">{{ workout.name }}</h2>
                                    {% if workout.description %}
                                        <p class="current-workout-description">{{ workout.description }}</p>
                                    {% endif %}
                                </div>
                                
                                <div class="workout-metadata-badges">
                                    {% if workout.category %}
                                        <span class="metadata-badge category-badge">
                                            <i class="fa-solid fa-tag"></i>
                                            {{ workout.category.name }}
                                        </span>
                                    {% endif %}
                                    <span class="metadata-badge exercise-count-badge">
                                        <i class="fa-solid fa-list"></i>
                                        {{ workout.exercises|length }} exercise{{ 's' if workout.exercises|length != 1 else '' }}
                                    </span>
                                    <span class="metadata-badge duration-badge">
                                        <i class="fa-solid fa-clock"></i>
                                        ~{{ (workout.exercises|length * 15) }} min
                                    </span>
                                </div>
                            </div>
                            
                            <div class="workout-actions-quick">
                                <button type="button" class="quick-action-btn edit-btn edit-{{ workout.id }}" data-workout-id="{{ workout.id }}">
                                    <i class="fa-solid fa-edit"></i>
                                    <span>Edit</span>
                                </button>
                                <button type="button" class="quick-action-btn timer-btn" data-workout-id="{{ workout.id }}">
                                    <i class="fa-solid fa-stopwatch"></i>
                                    <span>Timer</span>
                                </button>
                            </div>
                        </div>
                    </section>

                    <!-- Enhanced Exercises Grid -->
                    <section class="exercises-training-section">
                        <div class="section-header">
                            <h3 class="section-title">
                                <i class="fa-solid fa-fire"></i>
                                Training Exercises
                            </h3>
                            <div class="progress-overview">
                                <span class="progress-text">Progress:</span>
                                <div class="mini-progress-bar">
                                    {% set completed_exercises = [] %}
                                    {% for exercise in workout.exercises %}
                                        {% if exercise.weight is not none and exercise.weight > 0 and exercise.reps is not none and exercise.reps.strip() != '' %}
                                            {% set _ = completed_exercises.append(exercise.name) %}
                                        {% endif %}
                                    {% endfor %}
                                    {% set completed_count = completed_exercises | length %}
                                    {% set total = workout.exercises|length %}
                                    <div class="progress-fill" id="mini-progress-{{ workout.id }}" 
                                         style="width: {{ ((completed_count / total * 100) | round(0) | int) if total > 0 else 0 }}%">
                                    </div>
                                </div>
                                <span class="progress-percentage" id="mini-progress-text-{{ workout.id }}">
                                    {{ ((completed_count / total * 100) | round(0) | int) if total > 0 else 0 }}%
                                </span>
                            </div>
                        </div>
                        
                        <div class="exercises-grid-modern">
                            {% for exercise in workout.exercises %}
                                <article class="exercise-card-modern" data-exercise-index="{{ loop.index0 }}" data-exercise-id="{{ exercise.id }}">
                                    <!-- Exercise Card Header -->
                                    <header class="exercise-card-header">
                                        <div class="exercise-number-badge">
                                            <span class="exercise-position">{{ loop.index }}</span>
                                        </div>
                                        <div class="exercise-info">
                                            <h4 class="exercise-name">{{ exercise.name }}</h4>
                                            <div class="exercise-status-indicator">
                                                <span class="status-badge pending">
                                                    <i class="fa-regular fa-circle"></i>
                                                    Pending
                                                </span>
                                            </div>
                                        </div>
                                    </header>
                                    
                                    <!-- Exercise Card Body -->
                                    <div class="exercise-card-body">
                                        <div class="exercise-metrics-container">
                                            
                                            <!-- Interactive Weight Input -->
                                            <div class="metric-group weight-metric">
                                                <label class="metric-label">
                                                    <i class="fa-solid fa-weight-hanging"></i>
                                                    Weight
                                                </label>
                                                
                                                <div class="metric-input weight-input-interactive">
                                                    <div class="input-group-modern">
                                                        {% set last_session = last_session_data.get(workout.id, {}).get(exercise.name, {}) %}
                                                        {% if last_session.get('weight') %}
                                                            <div class="previous-session-badge weight-badge">
                                                                <i class="fa-solid fa-history"></i>
                                                                <span class="badge-text">Last: {{ last_session.weight }}kg</span>
                                                            </div>
                                                        {% endif %}
                                                        <input 
                                                            id="weight-{{ workout.id }}-{{ loop.index0 }}" 
                                                            class="metric-input-field weight-field interactive-input" 
                                                            type="number" 
                                                            step="0.01" 
                                                            placeholder="{% if last_session.get('weight') %}{{ last_session.weight }}{% else %}Enter weight{% endif %}" 
                                                            name="weight" 
                                                            value=""
                                                            min="0"
                                                            max="999.99"
                                                            aria-label="Weight for {{ exercise.name }}"
                                                            data-exercise-id="{{ exercise.id }}"
                                                            data-workout-id="{{ workout.id }}"
                                                            data-field-type="weight"
                                                            data-last-weight="{{ last_session.get('weight', '') }}"
                                                            data-original-weight="{% if exercise.weight is not none %}{{ (exercise.weight | int) if (exercise.weight | float | is_integer) else exercise.weight }}{% endif %}"
                                                            disabled
                                                            readonly
                                                        >
                                                        {% if last_session.get('weight') %}
                                                            <button type="button" class="quick-fill-last-session" 
                                                                    title="Fill with last session: {{ last_session.weight }}kg"
                                                                    data-target="weight-{{ workout.id }}-{{ loop.index0 }}"
                                                                    data-value="{{ last_session.weight }}"
                                                                    disabled>
                                                                Last
                                                            </button>
                                                        {% endif %}
                                                        <span class="input-unit">kg</span>
                                                        <div class="input-focus-line"></div>
                                                    </div>
                                                    <div class="save-indicator" style="display: none;">
                                                        <i class="fa-solid fa-check"></i>
                                                        <span>Saved</span>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Interactive Reps Input -->
                                            <div class="metric-group reps-metric">
                                                <label class="metric-label">
                                                    <i class="fa-solid fa-repeat"></i>
                                                    Reps
                                                </label>
                                                
                                                <div class="metric-input reps-input-interactive">
                                                    <div class="input-group-modern">
                                                        {% set last_session = last_session_data.get(workout.id, {}).get(exercise.name, {}) %}
                                                        {% if last_session.get('reps') %}
                                                            <div class="previous-session-badge reps-badge">
                                                                <i class="fa-solid fa-history"></i>
                                                                <span class="badge-text">Last: {{ last_session.reps }} reps</span>
                                                            </div>
                                                        {% endif %}
                                                        <input 
                                                            id="reps-{{ workout.id }}-{{ loop.index0 }}" 
                                                            class="metric-input-field reps-field interactive-input" 
                                                            type="text" 
                                                            placeholder="{% if last_session.get('reps') %}{{ last_session.reps }}{% else %}e.g., 8-12 or 10{% endif %}" 
                                                            name="reps" 
                                                            value="" 
                                                            maxlength="20"
                                                            aria-label="Reps for {{ exercise.name }}"
                                                            data-exercise-id="{{ exercise.id }}"
                                                            data-workout-id="{{ workout.id }}"
                                                            data-field-type="reps"
                                                            data-last-reps="{{ last_session.get('reps', '') }}"
                                                            data-original-reps="{{ exercise.reps or '' }}"
                                                            disabled
                                                            readonly
                                                        >
                                                        {% if last_session.get('reps') %}
                                                            <button type="button" class="quick-fill-last-session" 
                                                                    title="Fill with last session: {{ last_session.reps }} reps"
                                                                    data-target="reps-{{ workout.id }}-{{ loop.index0 }}"
                                                                    data-value="{{ last_session.reps }}"
                                                                    disabled>
                                                                Last
                                                            </button>
                                                        {% endif %}
                                                        <div class="input-focus-line"></div>
                                                    </div>
                                                    <div class="save-indicator" style="display: none;">
                                                        <i class="fa-solid fa-check"></i>
                                                        <span>Saved</span>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Interactive Details Section (if applicable) -->
                                            {% if exercise.include_details %}
                                                <div class="metric-group details-metric">
                                                    <label class="metric-label">
                                                        <i class="fa-solid fa-clipboard-list"></i>
                                                        Details
                                                    </label>
                                                    
                                                    <div class="metric-input details-input-interactive">
                                                        <div class="input-group-modern">
                                                            <input 
                                                                id="details-{{ workout.id }}-{{ loop.index0 }}" 
                                                                class="metric-input-field details-field interactive-input" 
                                                                type="text" 
                                                                placeholder="e.g., 3x8, seat 5" 
                                                                name="details" 
                                                                value="" 
                                                                maxlength="50"
                                                                aria-label="Details for {{ exercise.name }}"
                                                                data-exercise-id="{{ exercise.id }}"
                                                                data-workout-id="{{ workout.id }}"
                                                                data-field-type="details"
                                                                data-original-details="{{ exercise.details or '' }}"
                                                                disabled
                                                                readonly
                                                            >
                                                            <div class="input-focus-line"></div>
                                                        </div>
                                                        <div class="save-indicator" style="display: none;">
                                                            <i class="fa-solid fa-check"></i>
                                                            <span>Saved</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endif %}

                                        </div>
                                    </div>
                                    
                                    <!-- Exercise Card Footer -->
                                    <footer class="exercise-card-footer">
                                        <div class="exercise-actions">
                                            <button type="button" class="exercise-action-btn quick-log-btn" data-exercise-index="{{ loop.index0 }}">
                                                <i class="fa-solid fa-plus-circle"></i>
                                                Quick Log
                                            </button>
                                            <button type="button" class="exercise-action-btn save-exercise-btn" 
                                                    data-exercise-id="{{ exercise.id }}" 
                                                    data-workout-id="{{ workout.id }}"
                                                    data-exercise-index="{{ loop.index0 }}">
                                                <i class="fa-solid fa-save"></i>
                                                Save
                                            </button>
                                            <button type="button" class="exercise-action-btn notes-btn" data-exercise-index="{{ loop.index0 }}">
                                                <i class="fa-solid fa-sticky-note"></i>
                                                Notes
                                            </button>
                                        </div>
                                    </footer>
                                </article>
                            {% endfor %}
                        </div>
                    </section>

                    <!-- Enhanced Progress Summary -->
                    <section class="workout-progress-summary">
                        <div class="progress-card">
                            <div class="progress-card-header">
                                <div class="progress-icon">
                                    <i class="fa-solid fa-chart-line"></i>
                                </div>
                                <div class="progress-title-section">
                                    <h3 class="progress-title">Workout Progress</h3>
                                    <p class="progress-subtitle">Track your completion status</p>
                                </div>
                            </div>
                            
                            <div class="progress-metrics">
                                <div class="progress-stats-grid">
                                    <div class="progress-stat completed-stat">
                                        <div class="stat-icon">
                                            <i class="fa-solid fa-check-circle"></i>
                                        </div>
                                        <div class="stat-info">
                                            <span class="stat-value" id="completed-exercises-{{ workout.id }}">
                                                {% set completed_exercises_count = [] %}
                                                {% for exercise in workout.exercises %}
                                                    {% if exercise.weight is not none and exercise.weight > 0 and exercise.reps is not none and exercise.reps.strip() != '' %}
                                                        {% set _ = completed_exercises_count.append(exercise.name) %}
                                                    {% endif %}
                                                {% endfor %}
                                                {{ completed_exercises_count | length }}
                                            </span>
                                            <span class="stat-label">Completed</span>
                                        </div>
                                    </div>
                                    
                                    <div class="progress-stat total-stat">
                                        <div class="stat-icon">
                                            <i class="fa-solid fa-list"></i>
                                        </div>
                                        <div class="stat-info">
                                            <span class="stat-value">{{ workout.exercises|length }}</span>
                                            <span class="stat-label">Total</span>
                                        </div>
                                    </div>
                                    
                                    <div class="progress-stat percentage-stat">
                                        <div class="stat-icon">
                                            <i class="fa-solid fa-percentage"></i>
                                        </div>
                                        <div class="stat-info">
                                            <span class="stat-value" id="completion-percentage-{{ workout.id }}">
                                                {% set completed_exercises_pct = [] %}
                                                {% for exercise in workout.exercises %}
                                                    {% if exercise.weight is not none and exercise.weight > 0 and exercise.reps is not none and exercise.reps.strip() != '' %}
                                                        {% set _ = completed_exercises_pct.append(exercise.name) %}
                                                    {% endif %}
                                                {% endfor %}
                                                {{ ((completed_exercises_pct | length / workout.exercises|length * 100) | round(0) | int) if workout.exercises|length > 0 else 0 }}%
                                            </span>
                                            <span class="stat-label">Complete</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="progress-bar-container">
                                    <div class="progress-bar-track">
                                        {% set completed_exercises_progress = [] %}
                                        {% for exercise in workout.exercises %}
                                            {% if exercise.weight is not none and exercise.weight > 0 and exercise.reps is not none and exercise.reps.strip() != '' %}
                                                {% set _ = completed_exercises_progress.append(exercise.name) %}
                                            {% endif %}
                                        {% endfor %}
                                        <div class="progress-bar-fill" id="progress-fill-{{ workout.id }}" 
                                             style="width: {{ ((completed_exercises_progress | length / workout.exercises|length * 100) | round(0) | int) if workout.exercises|length > 0 else 0 }}%">
                                            <div class="progress-bar-glow"></div>
                                        </div>
                                    </div>
                                    <div class="progress-markers">
                                        {% for i in range(workout.exercises|length) %}
                                            <div class="progress-marker" data-exercise="{{ i }}"></div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                </div>
            {% endfor %}
        </main>
    </div>

{% endif %}

<!-- Enhanced Workout Timer Modal -->
<div class="workout-timer-modal" id="workout-timer-modal">
    <div class="timer-modal-overlay"></div>
    <div class="timer-modal-content">
        <header class="timer-modal-header">
            <h3 class="timer-title">
                <i class="fa-solid fa-stopwatch"></i>
                Workout Timer
            </h3>
            <button class="timer-close-btn" id="close-timer-modal">
                <i class="fa-solid fa-times"></i>
            </button>
        </header>
        
        <div class="timer-display">
            <div class="timer-circle">
                <div class="timer-time" id="timer-display">00:00</div>
                <div class="timer-label">Elapsed Time</div>
            </div>
        </div>
        
        <div class="timer-controls">
            <button class="timer-btn start-btn" id="timer-start">
                <i class="fa-solid fa-play"></i>
                Start
            </button>
            <button class="timer-btn pause-btn" id="timer-pause" hidden>
                <i class="fa-solid fa-pause"></i>
                Pause
            </button>
            <button class="timer-btn reset-btn" id="timer-reset">
                <i class="fa-solid fa-refresh"></i>
                Reset
            </button>
        </div>
    </div>
</div>

<!-- Enhanced JavaScript -->
<script>
    // Enhanced workout selection and management
    document.addEventListener('DOMContentLoaded', function() {
        const selectWorkout = document.getElementById('select_workout');
        
        // Initialize workout display
        {% if displayRequested and requested_workout %}
            if (selectWorkout) {
                selectWorkout.value = "{{ requested_workout }}";
                showSelectedWorkout("{{ requested_workout }}");
            }
        {% else %}
            if (selectWorkout && selectWorkout.options.length > 0) {
                const firstWorkoutId = selectWorkout.options[0].value;
                showSelectedWorkout(firstWorkoutId);
            }
        {% endif %}

        // Handle workout selection change with animation
        if (selectWorkout) {
            selectWorkout.addEventListener('change', function() {
                const selectedWorkoutId = this.value;
                animateWorkoutTransition(selectedWorkoutId);
            });
        }

        // Initialize timer functionality
        initializeWorkoutTimer();
        
        // Initialize progress animations
        animateProgressBars();
        
        // Initialize quick action buttons
        initializeQuickActions();
        
        // Initialize interactive input fields
        initializeInteractiveInputs();
        
        // Initialize quick fill buttons
        initializeQuickFillButtons();
    });

    function showSelectedWorkout(workoutId) {
        // Hide all workouts
        const allWorkouts = document.querySelectorAll('.workout-session-container');
        allWorkouts.forEach(workout => {
            workout.hidden = true;
            workout.classList.remove('active');
        });

        // Show selected workout with animation
        const selectedWorkout = document.querySelector(`.workout-${workoutId}`);
        if (selectedWorkout) {
            selectedWorkout.hidden = false;
            setTimeout(() => {
                selectedWorkout.classList.add('active');
            }, 50);
        }
    }

    function animateWorkoutTransition(workoutId) {
        const currentWorkout = document.querySelector('.workout-session-container:not([hidden])');
        const newWorkout = document.querySelector(`.workout-${workoutId}`);
        
        if (currentWorkout) {
            currentWorkout.style.opacity = '0';
            currentWorkout.style.transform = 'translateY(-20px)';
            
            setTimeout(() => {
                currentWorkout.hidden = true;
                currentWorkout.style.opacity = '';
                currentWorkout.style.transform = '';
                
                if (newWorkout) {
                    newWorkout.hidden = false;
                    newWorkout.style.opacity = '0';
                    newWorkout.style.transform = 'translateY(20px)';
                    
                    setTimeout(() => {
                        newWorkout.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                        newWorkout.style.opacity = '1';
                        newWorkout.style.transform = 'translateY(0)';
                        
                        setTimeout(() => {
                            newWorkout.style.transition = '';
                        }, 400);
                    }, 50);
                }
            }, 200);
        } else {
            showSelectedWorkout(workoutId);
        }
    }

    function updateProgressDisplay(workoutId) {
        // Calculate progress based on Exercise table data (same as template logic)
        // This ensures consistency between template rendering and JS updates
        
        // Make an AJAX call to get current completion status from backend
        fetch(`/workout?ajax=1&workout_id=${workoutId}`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.completion_status) {
                updateProgressWithBackendData(workoutId, data.completion_status);
            } else {
                // Fallback to client-side calculation
                updateProgressDisplayFallback(workoutId);
            }
        })
        .catch(error => {
            console.warn('Progress update failed, using fallback:', error);
            updateProgressDisplayFallback(workoutId);
        });
    }
    
    function updateProgressDisplayFallback(workoutId) {
        // Make AJAX call to get accurate progress from backend
        // This ensures progress reflects actual saved Exercise table data
        fetch(`/workout?ajax=1&workout_id=${workoutId}`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.completion_status) {
                updateProgressWithBackendData(workoutId, data.completion_status);
                
                // Update exercise status badges based on backend data
                const workoutContainer = document.querySelector(`.workout-${workoutId}`);
                if (workoutContainer) {
                    const exerciseCards = workoutContainer.querySelectorAll('.exercise-card-modern');
                    exerciseCards.forEach((card, index) => {
                        const exerciseId = card.dataset.exerciseId;
                        // Check if this exercise is completed based on backend data
                        const isCompleted = checkExerciseCompletionFromBackend(exerciseId, data.completion_status);
                        updateExerciseStatusBadge(card, isCompleted);
                    });
                }
                
                // Show completion celebration if workout is fully completed
                if (data.completion_status.percentage === 100) {
                    showWorkoutCompletionCelebration(workoutId);
                }
            }
        })
        .catch(error => {
            console.warn('Progress update failed:', error);
            // Fallback to client-side calculation only if backend fails
            updateProgressDisplayClientSide(workoutId);
        });
    }
    
    function updateProgressDisplayClientSide(workoutId) {
        // Client-side fallback that matches template logic
        const workoutContainer = document.querySelector(`.workout-${workoutId}`);
        if (!workoutContainer) return;
        
        // Get all exercise cards for this workout
        const exerciseCards = workoutContainer.querySelectorAll('.exercise-card-modern');
        let completedCount = 0;
        const totalCount = exerciseCards.length;
        
        // Count completed exercises based on original Exercise table data
        exerciseCards.forEach(card => {
            const weightInput = card.querySelector('.weight-field');
            const repsInput = card.querySelector('.reps-field');
            
            // Check original data from Exercise table (data attributes)
            const originalWeight = weightInput ? weightInput.dataset.originalWeight : '';
            const originalReps = repsInput ? repsInput.dataset.originalReps : '';
            
            const hasOriginalWeight = originalWeight && originalWeight.trim() !== '' && parseFloat(originalWeight) > 0;
            const hasOriginalReps = originalReps && originalReps.trim() !== '';
            
            if (hasOriginalWeight && hasOriginalReps) {
                completedCount++;
                updateExerciseStatusBadge(card, true);
            } else {
                updateExerciseStatusBadge(card, false);
            }
        });
        
        // Calculate percentage
        const percentage = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
        
        // Update progress displays
        updateProgressElementsWithData(workoutId, {
            completed: completedCount,
            total: totalCount,
            percentage: percentage
        });
        
        // Show completion celebration if workout is fully completed
        if (percentage === 100 && completedCount === totalCount) {
            showWorkoutCompletionCelebration(workoutId);
        }
    }
    
    function checkExerciseCompletionFromBackend(exerciseId, completionStatus) {
        // This is a simplified check - in a more advanced implementation,
        // the backend would return per-exercise completion status
        // For now, we'll use a heuristic based on the overall progress
        return false; // Default to not completed
    }
    
    function updateProgressElementsWithData(workoutId, data) {
        const { completed, total, percentage } = data;
        
        // Update mini progress bar
        const miniProgressBar = document.getElementById(`mini-progress-${workoutId}`);
        const miniProgressText = document.getElementById(`mini-progress-text-${workoutId}`);
        
        if (miniProgressBar) {
            miniProgressBar.style.transition = 'width 0.5s ease-out';
            miniProgressBar.style.width = `${percentage}%`;
            miniProgressBar.classList.add('progress-updated');
            setTimeout(() => {
                miniProgressBar.classList.remove('progress-updated');
            }, 1000);
        }
        if (miniProgressText) {
            miniProgressText.textContent = `${percentage}%`;
        }
        
        // Update main progress bar
        const mainProgressBar = document.getElementById(`progress-fill-${workoutId}`);
        if (mainProgressBar) {
            mainProgressBar.style.transition = 'width 0.5s ease-out';
            mainProgressBar.style.width = `${percentage}%`;
            mainProgressBar.classList.add('progress-updated');
            setTimeout(() => {
                mainProgressBar.classList.remove('progress-updated');
            }, 1000);
        }
        
        // Update completed exercises count
        const completedExercisesEl = document.getElementById(`completed-exercises-${workoutId}`);
        if (completedExercisesEl) {
            completedExercisesEl.textContent = completed;
        }
        
        // Update completion percentage
        const completionPercentageEl = document.getElementById(`completion-percentage-${workoutId}`);
        if (completionPercentageEl) {
            completionPercentageEl.textContent = `${percentage}%`;
        }
    }
    
    // PUBLIC_INTERFACE
    /**
     * Update progress indicators using backend completion status data.
     * This is more accurate than client-side calculation.
     */
    function updateProgressWithBackendData(workoutId, completionStatus) {
        const { completed, total, percentage } = completionStatus;
        
        // Update mini progress bar
        const miniProgressBar = document.getElementById(`mini-progress-${workoutId}`);
        const miniProgressText = document.getElementById(`mini-progress-text-${workoutId}`);
        
        if (miniProgressBar) {
            miniProgressBar.style.transition = 'width 0.5s ease-out';
            miniProgressBar.style.width = `${percentage}%`;
            miniProgressBar.classList.add('progress-updated');
            setTimeout(() => {
                miniProgressBar.classList.remove('progress-updated');
            }, 1000);
        }
        if (miniProgressText) {
            miniProgressText.textContent = `${percentage}%`;
        }
        
        // Update main progress bar
        const mainProgressBar = document.getElementById(`progress-fill-${workoutId}`);
        if (mainProgressBar) {
            mainProgressBar.style.transition = 'width 0.5s ease-out';
            mainProgressBar.style.width = `${percentage}%`;
            mainProgressBar.classList.add('progress-updated');
            setTimeout(() => {
                mainProgressBar.classList.remove('progress-updated');
            }, 1000);
        }
        
        // Update completed exercises count
        const completedExercisesEl = document.getElementById(`completed-exercises-${workoutId}`);
        if (completedExercisesEl) {
            completedExercisesEl.textContent = completed;
        }
        
        // Update completion percentage
        const completionPercentageEl = document.getElementById(`completion-percentage-${workoutId}`);
        if (completionPercentageEl) {
            completionPercentageEl.textContent = `${percentage}%`;
        }
        
        // Show completion celebration if workout is fully completed
        if (percentage === 100 && completed === total) {
            showWorkoutCompletionCelebration(workoutId);
        }
    }

    function animateProgressBars() {
        const progressBars = document.querySelectorAll('.progress-bar-fill');
        progressBars.forEach(bar => {
            const width = bar.style.width;
            bar.style.width = '0%';
            setTimeout(() => {
                bar.style.transition = 'width 1s ease-out';
                bar.style.width = width;
            }, 500);
        });
    }

    function initializeWorkoutTimer() {
        const timerModal = document.getElementById('workout-timer-modal');
        const closeBtn = document.getElementById('close-timer-modal');
        const startBtn = document.getElementById('timer-start');
        const pauseBtn = document.getElementById('timer-pause');
        const resetBtn = document.getElementById('timer-reset');
        const timerDisplay = document.getElementById('timer-display');
        
        let startTime = null;
        let pausedTime = 0;
        let isRunning = false;
        let timerInterval = null;

        // Open timer modal
        document.querySelectorAll('.timer-btn, .timer-control').forEach(btn => {
            btn.addEventListener('click', function() {
                timerModal.classList.add('active');
                document.body.style.overflow = 'hidden';
            });
        });

        // Close timer modal
        closeBtn.addEventListener('click', function() {
            timerModal.classList.remove('active');
            document.body.style.overflow = '';
        });

        // Timer controls
        startBtn.addEventListener('click', function() {
            if (!isRunning) {
                startTime = Date.now() - pausedTime;
                isRunning = true;
                startBtn.hidden = true;
                pauseBtn.hidden = false;
                
                timerInterval = setInterval(updateTimer, 1000);
            }
        });

        pauseBtn.addEventListener('click', function() {
            if (isRunning) {
                isRunning = false;
                pausedTime = Date.now() - startTime;
                startBtn.hidden = false;
                pauseBtn.hidden = true;
                clearInterval(timerInterval);
            }
        });

        resetBtn.addEventListener('click', function() {
            isRunning = false;
            pausedTime = 0;
            startTime = null;
            startBtn.hidden = false;
            pauseBtn.hidden = true;
            clearInterval(timerInterval);
            timerDisplay.textContent = '00:00';
        });

        function updateTimer() {
            if (!isRunning) return;
            
            const elapsed = Date.now() - startTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            
            timerDisplay.textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
    }

    function initializeQuickActions() {
        // Quick log buttons - enable fields and fill with last session data
        document.querySelectorAll('.quick-log-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const exerciseIndex = this.dataset.exerciseIndex;
                const exerciseCard = this.closest('.exercise-card-modern');
                const weightInput = exerciseCard.querySelector('.weight-field');
                const repsInput = exerciseCard.querySelector('.reps-field');
                const detailsInput = exerciseCard.querySelector('.details-field');
                
                // Enable all input fields
                if (weightInput) {
                    weightInput.disabled = false;
                    weightInput.readOnly = false;
                    weightInput.classList.add('field-enabled');
                }
                if (repsInput) {
                    repsInput.disabled = false;
                    repsInput.readOnly = false;
                    repsInput.classList.add('field-enabled');
                }
                if (detailsInput) {
                    detailsInput.disabled = false;
                    detailsInput.readOnly = false;
                    detailsInput.classList.add('field-enabled');
                }
                
                // Enable quick fill buttons
                const quickFillButtons = exerciseCard.querySelectorAll('.quick-fill-last-session');
                quickFillButtons.forEach(button => {
                    button.disabled = false;
                });
                
                // Fill weight with last session data if available
                const lastWeight = weightInput.dataset.lastWeight;
                if (lastWeight && weightInput) {
                    weightInput.value = lastWeight;
                }
                
                // Fill reps with last session data if available  
                const lastReps = repsInput.dataset.lastReps;
                if (lastReps && repsInput) {
                    repsInput.value = lastReps;
                }
                
                // Add visual feedback to exercise card
                exerciseCard.classList.add('exercise-enabled');
                
                // Update exercise status badge
                const statusBadge = exerciseCard.querySelector('.status-badge');
                if (statusBadge) {
                    statusBadge.className = 'status-badge active';
                    statusBadge.innerHTML = '<i class="fa-solid fa-edit"></i> Active';
                }
                
                // Focus on weight input for user to continue
                if (weightInput) {
                    weightInput.focus();
                }
                
                // Visual feedback for quick log button
                this.style.background = '#059669';
                this.innerHTML = '<i class="fa-solid fa-check"></i> Enabled';
                this.disabled = true;
                
                // Show notification
                showQuickLogNotification(exerciseCard, 'Exercise enabled and filled with last session data!');
                
                // NO progress update when Quick Log is pressed - only on Save
            });
        });

        // Notes buttons (placeholder for future enhancement)
        document.querySelectorAll('.notes-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Could open a notes modal or expand details section
                console.log('Notes feature - coming soon!');
            });
        });
    }

    // PUBLIC_INTERFACE
    /**
     * Initialize manual save buttons for exercise data.
     * Removes auto-completion and provides explicit save functionality.
     */
    function initializeInteractiveInputs() {
        // Initialize save buttons
        document.querySelectorAll('.save-exercise-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const exerciseId = this.dataset.exerciseId;
                const workoutId = this.dataset.workoutId;
                const exerciseIndex = this.dataset.exerciseIndex;
                
                // Find the exercise card
                const exerciseCard = this.closest('.exercise-card-modern');
                if (!exerciseCard) return;
                
                // Collect all field values
                const weightInput = exerciseCard.querySelector('.weight-field');
                const repsInput = exerciseCard.querySelector('.reps-field');
                const detailsInput = exerciseCard.querySelector('.details-field');
                
                const exerciseData = {
                    weight: weightInput ? weightInput.value.trim() : '',
                    reps: repsInput ? repsInput.value.trim() : '',
                    details: detailsInput ? detailsInput.value.trim() : ''
                };
                
                // Validate required fields
                const validationResult = validateExerciseData(exerciseData);
                if (!validationResult.isValid) {
                    showValidationError(exerciseCard, validationResult.message);
                    return;
                }
                
                // Save the exercise
                saveCompleteExercise(exerciseId, workoutId, exerciseData, exerciseCard);
            });
        });
        
        // Add input validation on focus/blur for immediate feedback
        document.querySelectorAll('.interactive-input').forEach(input => {
            input.addEventListener('focus', function() {
                clearValidationErrors(this.closest('.exercise-card-modern'));
            });
            
            // Add real-time progress tracking
            input.addEventListener('input', function() {
                const exerciseCard = this.closest('.exercise-card-modern');
                const workoutContainer = exerciseCard.closest('.workout-session-container');
                const workoutId = workoutContainer.dataset.workoutId;
                
                // Update progress display after a short delay to avoid excessive updates
                clearTimeout(this.progressUpdateTimer);
                this.progressUpdateTimer = setTimeout(() => {
                    updateProgressDisplayFallback(workoutId);
                }, 500);
            });
        });
    }
    
    // PUBLIC_INTERFACE
    /**
     * Initialize quick fill buttons for previous session data.
     */
    function initializeQuickFillButtons() {
        document.querySelectorAll('.quick-fill-last-session').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const targetId = this.dataset.target;
                const value = this.dataset.value;
                const targetInput = document.getElementById(targetId);
                
                if (targetInput && value) {
                    // Fill the input with previous session value
                    targetInput.value = value;
                    targetInput.focus();
                    
                    // Trigger input event to update any listeners
                    targetInput.dispatchEvent(new Event('input', { bubbles: true }));
                    
                    // Show visual feedback
                    this.style.background = '#059669';
                    this.textContent = '✓';
                    
                    // Reset button after delay
                    setTimeout(() => {
                        this.style.background = '#10b981';
                        this.textContent = 'Last';
                    }, 1500);
                    
                    // NO progress update when Quick Fill is used - only on Save
                }
            });
        });
        
        // Initialize badge click functionality
        initializePreviousSessionBadges();
    }
    
    // PUBLIC_INTERFACE
    /**
     * Initialize previous session badges to be clickable for quick fill.
     */
    function initializePreviousSessionBadges() {
        document.querySelectorAll('.previous-session-badge').forEach(badge => {
            badge.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Find the corresponding input field
                const inputGroup = this.closest('.input-group-modern');
                const inputField = inputGroup.querySelector('.metric-input-field');
                const quickFillBtn = inputGroup.querySelector('.quick-fill-last-session');
                
                if (inputField && !inputField.disabled && !inputField.readOnly) {
                    // If there's a quick fill button, use its value
                    if (quickFillBtn) {
                        const value = quickFillBtn.dataset.value;
                        if (value) {
                            inputField.value = value;
                            inputField.focus();
                            
                            // Trigger input event
                            inputField.dispatchEvent(new Event('input', { bubbles: true }));
                            
                            // Show badge feedback
                            this.style.transform = 'scale(1.1)';
                            this.style.opacity = '1';
                            
                            setTimeout(() => {
                                this.style.transform = '';
                                this.style.opacity = '';
                            }, 300);
                            
                            // NO progress update when badge is clicked - only on Save
                        }
                    }
                } else {
                    // If input is disabled, show notification that user needs to enable it first
                    showBadgeClickNotification(badge, 'Click "Quick Log" to enable editing first');
                }
            });
            
            // Add hover effect to indicate clickability
            badge.style.cursor = 'pointer';
            badge.title = 'Click to fill input with previous session value';
        });
    }
    
    // PUBLIC_INTERFACE
    /**
     * Show notification when badge is clicked.
     */
    function showBadgeClickNotification(badge, message) {
        const notification = document.createElement('div');
        notification.className = 'badge-click-notification';
        notification.textContent = message;
        notification.style.cssText = `
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            white-space: nowrap;
            z-index: 1000;
            animation: fadeInOut 2s ease-out forwards;
        `;
        
        badge.style.position = 'relative';
        badge.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 2000);
    }
    
    // PUBLIC_INTERFACE
    /**
     * Validate exercise data before saving.
     * Checks that required fields are filled.
     */
    function validateExerciseData(exerciseData) {
        const errors = [];
        
        // Weight is required and must be a valid number > 0
        if (!exerciseData.weight || exerciseData.weight === '') {
            errors.push('Weight is required');
        } else {
            const weightNum = parseFloat(exerciseData.weight);
            if (isNaN(weightNum) || weightNum <= 0) {
                errors.push('Weight must be a valid number greater than 0');
            } else if (weightNum > 999.99) {
                errors.push('Weight cannot exceed 999.99 kg');
            }
        }
        
        // Reps is required
        if (!exerciseData.reps || exerciseData.reps === '') {
            errors.push('Reps is required');
        } else if (exerciseData.reps.length > 20) {
            errors.push('Reps value too long (max 20 characters)');
        }
        
        // Details validation (if provided)
        if (exerciseData.details && exerciseData.details.length > 50) {
            errors.push('Details too long (max 50 characters)');
        }
        
        return {
            isValid: errors.length === 0,
            message: errors.join(', ')
        };
    }
    
    // PUBLIC_INTERFACE
    /**
     * Save complete exercise data via AJAX after validation.
     * Only saves when all required fields are valid.
     */
    function saveCompleteExercise(exerciseId, workoutId, exerciseData, exerciseCard) {
        showExerciseSaveStatus(exerciseCard, 'saving');
        
        // Save all exercise fields
        fetch('/workout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                workout_id: workoutId,
                exercise_id: exerciseId,
                exercise_data: exerciseData,
                action: 'save_complete_exercise'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showExerciseSaveStatus(exerciseCard, 'success');
                
                // Update exercise status badge to completed
                updateExerciseStatusBadge(exerciseCard, true);
                
                // Update progress indicators with backend data
                if (data.completion_status) {
                    updateProgressWithBackendData(workoutId, data.completion_status);
                } else {
                    updateProgressDisplay(workoutId);
                }
                
                // Show success notification
                showSuccessNotification(exerciseCard, 'Exercise saved and marked as complete!');
                
            } else {
                showExerciseSaveStatus(exerciseCard, 'error');
                console.error('Save failed:', data.errors || data.error);
                
                // Show user-friendly error
                if (data.errors && data.errors.length > 0) {
                    showValidationError(exerciseCard, data.errors[0]);
                } else if (data.error) {
                    showValidationError(exerciseCard, data.error);
                }
            }
        })
        .catch(error => {
            console.error('Network error:', error);
            showExerciseSaveStatus(exerciseCard, 'error');
            showValidationError(exerciseCard, 'Network error - please try again');
        });
    }
    
    // PUBLIC_INTERFACE
    /**
     * Show save status for the entire exercise card.
     */
    function showExerciseSaveStatus(exerciseCard, status) {
        const saveBtn = exerciseCard.querySelector('.save-exercise-btn');
        if (!saveBtn) return;
        
        const icon = saveBtn.querySelector('i');
        const text = saveBtn.querySelector('span') || saveBtn.lastChild;
        
        // Reset button classes
        saveBtn.className = 'exercise-action-btn save-exercise-btn';
        
        switch (status) {
            case 'saving':
                saveBtn.classList.add('saving');
                saveBtn.disabled = true;
                icon.className = 'fa-solid fa-spinner fa-spin';
                if (text.nodeType === Node.TEXT_NODE) {
                    text.textContent = ' Saving...';
                } else {
                    text.textContent = 'Saving...';
                }
                break;
                
            case 'success':
                saveBtn.classList.add('success');
                saveBtn.disabled = false;
                icon.className = 'fa-solid fa-check';
                if (text.nodeType === Node.TEXT_NODE) {
                    text.textContent = ' Saved';
                } else {
                    text.textContent = 'Saved';
                }
                
                // Reset after delay
                setTimeout(() => {
                    saveBtn.className = 'exercise-action-btn save-exercise-btn';
                    icon.className = 'fa-solid fa-save';
                    if (text.nodeType === Node.TEXT_NODE) {
                        text.textContent = ' Save';
                    } else {
                        text.textContent = 'Save';
                    }
                }, 3000);
                break;
                
            case 'error':
                saveBtn.classList.add('error');
                saveBtn.disabled = false;
                icon.className = 'fa-solid fa-exclamation-triangle';
                if (text.nodeType === Node.TEXT_NODE) {
                    text.textContent = ' Error';
                } else {
                    text.textContent = 'Error';
                }
                
                // Reset after delay
                setTimeout(() => {
                    saveBtn.className = 'exercise-action-btn save-exercise-btn';
                    icon.className = 'fa-solid fa-save';
                    if (text.nodeType === Node.TEXT_NODE) {
                        text.textContent = ' Save';
                    } else {
                        text.textContent = 'Save';
                    }
                }, 3000);
                break;
        }
    }
    
    // PUBLIC_INTERFACE
    /**
     * Show validation error message on exercise card.
     */
    function showValidationError(exerciseCard, message) {
        clearValidationErrors(exerciseCard);
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'exercise-validation-error';
        errorDiv.innerHTML = `<i class="fa-solid fa-exclamation-triangle"></i> ${message}`;
        
        const footer = exerciseCard.querySelector('.exercise-card-footer');
        footer.insertBefore(errorDiv, footer.firstChild);
        
        // Remove after delay
        setTimeout(() => {
            errorDiv.remove();
        }, 5000);
    }
    
    // PUBLIC_INTERFACE
    /**
     * Clear validation errors from exercise card.
     */
    function clearValidationErrors(exerciseCard) {
        const existingErrors = exerciseCard.querySelectorAll('.exercise-validation-error');
        existingErrors.forEach(error => error.remove());
    }
    
    // PUBLIC_INTERFACE
    /**
     * Update exercise status badge based on completion.
     */
    function updateExerciseStatusBadge(exerciseCard, isCompleted) {
        const statusBadge = exerciseCard.querySelector('.status-badge');
        if (!statusBadge) return;
        
        if (isCompleted) {
            statusBadge.className = 'status-badge completed';
            statusBadge.innerHTML = '<i class="fa-solid fa-check-circle"></i> Completed';
        } else {
            statusBadge.className = 'status-badge pending';
            statusBadge.innerHTML = '<i class="fa-regular fa-circle"></i> Pending';
        }
    }
    
    // PUBLIC_INTERFACE
    /**
     * Show success notification for exercise completion.
     */
    function showSuccessNotification(exerciseCard, message) {
        const notification = document.createElement('div');
        notification.className = 'exercise-success-notification';
        notification.innerHTML = `<i class="fa-solid fa-check-circle"></i> ${message}`;
        
        exerciseCard.style.position = 'relative';
        exerciseCard.appendChild(notification);
        
        // Remove after delay
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateY(-20px)';
            setTimeout(() => notification.remove(), 300);
        }, 4000);
    }
    
    // PUBLIC_INTERFACE
    /**
     * Show notification when quick log is activated.
     */
    function showQuickLogNotification(exerciseCard, message) {
        const notification = document.createElement('div');
        notification.className = 'exercise-quicklog-notification';
        notification.innerHTML = `<i class="fa-solid fa-info-circle"></i> ${message}`;
        
        exerciseCard.style.position = 'relative';
        exerciseCard.appendChild(notification);
        
        // Remove after delay
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateY(-20px)';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
    
    // PUBLIC_INTERFACE
    /**
     * Show celebration when workout is 100% completed.
     */
    function showWorkoutCompletionCelebration(workoutId) {
        const workoutContainer = document.querySelector(`.workout-${workoutId}`);
        if (!workoutContainer) return;
        
        // Avoid showing multiple celebrations
        if (workoutContainer.dataset.celebrationShown === 'true') return;
        workoutContainer.dataset.celebrationShown = 'true';
        
        // Create celebration overlay
        const celebration = document.createElement('div');
        celebration.className = 'workout-completion-celebration';
        celebration.innerHTML = `
            <div class="celebration-content">
                <div class="celebration-icon">
                    <i class="fa-solid fa-trophy"></i>
                </div>
                <h3 class="celebration-title">Workout Complete!</h3>
                <p class="celebration-message">Amazing job! You've completed all exercises.</p>
                <div class="celebration-confetti">
                    <div class="confetti-piece"></div>
                    <div class="confetti-piece"></div>
                    <div class="confetti-piece"></div>
                    <div class="confetti-piece"></div>
                    <div class="confetti-piece"></div>
                </div>
            </div>
        `;
        
        celebration.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.5s ease-out;
        `;
        
        // Add celebration styles
        const celebrationStyles = `
            .celebration-content {
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 2rem;
                border-radius: 1rem;
                text-align: center;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                position: relative;
                overflow: hidden;
            }
            .celebration-icon {
                font-size: 4rem;
                margin-bottom: 1rem;
                animation: bounce 1s infinite;
            }
            .celebration-title {
                font-size: 2rem;
                margin-bottom: 0.5rem;
                font-weight: bold;
            }
            .celebration-message {
                font-size: 1.2rem;
                opacity: 0.9;
            }
            .celebration-confetti {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
            }
            .confetti-piece {
                position: absolute;
                width: 10px;
                height: 10px;
                background: #ffd700;
                animation: confettiFall 3s linear infinite;
            }
            .confetti-piece:nth-child(1) { left: 10%; animation-delay: 0s; background: #ff6b6b; }
            .confetti-piece:nth-child(2) { left: 30%; animation-delay: 0.5s; background: #4ecdc4; }
            .confetti-piece:nth-child(3) { left: 50%; animation-delay: 1s; background: #45b7d1; }
            .confetti-piece:nth-child(4) { left: 70%; animation-delay: 1.5s; background: #96ceb4; }
            .confetti-piece:nth-child(5) { left: 90%; animation-delay: 2s; background: #feca57; }
            @keyframes confettiFall {
                0% { transform: translateY(-100vh) rotate(0deg); }
                100% { transform: translateY(100vh) rotate(360deg); }
            }
            @keyframes bounce {
                0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
                40% { transform: translateY(-30px); }
                60% { transform: translateY(-15px); }
            }
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
        `;
        
        // Add styles to document
        const styleSheet = document.createElement('style');
        styleSheet.textContent = celebrationStyles;
        document.head.appendChild(styleSheet);
        
        document.body.appendChild(celebration);
        
        // Remove celebration after delay
        setTimeout(() => {
            celebration.style.opacity = '0';
            setTimeout(() => {
                celebration.remove();
                styleSheet.remove();
                // Reset celebration flag after some time
                setTimeout(() => {
                    workoutContainer.dataset.celebrationShown = 'false';
                }, 30000); // 30 seconds
            }, 500);
        }, 4000);
        
        // Allow clicking to dismiss
        celebration.addEventListener('click', () => {
            celebration.style.opacity = '0';
            setTimeout(() => {
                celebration.remove();
                styleSheet.remove();
                workoutContainer.dataset.celebrationShown = 'false';
            }, 300);
        });
    }

    // Intersection Observer for animations
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver(function(entries) {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('animate-in');
            }
        });
    }, observerOptions);

    // Observe exercise cards for stagger animation
    document.querySelectorAll('.exercise-card-modern').forEach(card => {
        observer.observe(card);
    });
    
    // Add CSS for progress animations
    const progressAnimationStyles = `
        .progress-updated {
            animation: progressPulse 1s ease-out;
        }
        
        @keyframes progressPulse {
            0% { 
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0.3);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }
        
        .exercise-validation-error {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #ef4444;
            color: white;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 8px;
            animation: slideInUp 0.3s ease-out;
        }
        
        .exercise-success-notification {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            z-index: 1000;
            animation: slideInDown 0.3s ease-out;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .save-exercise-btn.saving {
            background: #fbbf24 !important;
            color: #92400e !important;
        }
        
        .save-exercise-btn.success {
            background: #10b981 !important;
            color: white !important;
        }
        
        .save-exercise-btn.error {
            background: #ef4444 !important;
            color: white !important;
        }
        
        /* Disabled field styles */
        .metric-input-field:disabled,
        .metric-input-field[readonly] {
            background-color: #f3f4f6 !important;
            color: #6b7280 !important;
            cursor: not-allowed !important;
            opacity: 0.6 !important;
            border-color: #d1d5db !important;
        }
        
        /* Enabled field styles */
        .metric-input-field.field-enabled {
            background-color: #ffffff !important;
            color: #1f2937 !important;
            cursor: text !important;
            opacity: 1 !important;
            border-color: #10b981 !important;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1) !important;
            animation: fieldEnable 0.3s ease-out !important;
        }
        
        @keyframes fieldEnable {
            from {
                opacity: 0.6;
                transform: scale(0.98);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* Exercise card enabled state */
        .exercise-card-modern.exercise-enabled {
            border-color: #10b981 !important;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2) !important;
            animation: cardEnable 0.4s ease-out !important;
        }
        
        @keyframes cardEnable {
            from {
                border-color: #e5e7eb;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }
            to {
                border-color: #10b981;
                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
            }
        }
        
        /* Quick log notification */
        .exercise-quicklog-notification {
            position: absolute;
            top: 10px;
            left: 10px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            z-index: 1000;
            animation: slideInLeft 0.3s ease-out;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* Status badge active state */
        .status-badge.active {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8) !important;
            color: white !important;
            animation: badgeActivate 0.3s ease-out !important;
        }
        
        @keyframes badgeActivate {
            from {
                background: #e5e7eb;
                color: #6b7280;
            }
            to {
                background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                color: white;
            }
        }
        
        /* Quick log button disabled state */
        .quick-log-btn:disabled {
            background: #059669 !important;
            cursor: not-allowed !important;
            opacity: 0.8 !important;
        }
        
        /* Disabled quick fill buttons */
        .quick-fill-last-session:disabled {
            display: none !important;
        }
    `;
    
    // Add progress animation styles to document
    const progressStyleSheet = document.createElement('style');
    progressStyleSheet.textContent = progressAnimationStyles;
    document.head.appendChild(progressStyleSheet);
</script>

<script type="text/javascript" src="/static/js/workout.js"></script>
<script type="text/javascript" src="/static/js/workout-progress-fix.js"></script>

{% endblock %}
